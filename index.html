<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propagate Protocol Token (PPT) - Meme Revolution!</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Fredoka+One&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.min.js"></script>
    <style>
        :root {
            --primary: #FF6B9D;
            --secondary: #00E5FF;
            --accent: #FFD166;
            --dark: #1A1A2E;
            --light: #F8F9FA;
            --success: #06D6A0;
            --danger: #EF476F;
            --meme-gradient: linear-gradient(45deg, #FF6B9D, #00E5FF, #FFD166);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Comic Neue', cursive;
            background-color: var(--dark);
            color: var(--light);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 107, 157, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 229, 255, 0.15) 0%, transparent 20%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 5px dashed var(--primary);
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-img {
            width: 70px;
            height: 70px;
            background: var(--meme-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: var(--dark);
            border: 3px solid var(--accent);
            box-shadow: 0 0 20px var(--secondary);
        }
        
        .logo-text {
            font-family: 'Fredoka One', cursive;
            font-size: 36px;
            background: var(--meme-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(255, 107, 157, 0.5);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .network-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(0, 229, 255, 0.1);
            border-radius: 50px;
            border: 2px solid var(--secondary);
        }
        
        .connect-wallet, .add-token-btn {
            background: var(--meme-gradient);
            color: var(--dark);
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-family: 'Fredoka One', cursive;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }
        
        .add-token-btn {
            background: linear-gradient(45deg, #FFD166, #FF9E00);
        }
        
        .connect-wallet:hover, .add-token-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .wallet-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        
        .wallet-balance {
            font-size: 12px;
            font-weight: normal;
            color: var(--dark);
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 2px;
        }
        
        /* Top Prize Pool Banner */
        .top-prize-banner {
            background: rgba(26, 26, 46, 0.9);
            border: 5px solid var(--accent);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(255, 209, 102, 0.3);
        }
        
        .top-prize-banner::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 209, 102, 0.1) 0%, transparent 70%);
            z-index: -1;
        }
        
        .top-prize-title {
            font-family: 'Fredoka One', cursive;
            font-size: 42px;
            background: linear-gradient(45deg, #FFD166, #FF9E00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 209, 102, 0.5);
        }
        
        .top-prize-amount {
            font-size: 56px;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 25px rgba(255, 209, 102, 0.7);
            margin-bottom: 15px;
        }
        
        .top-prize-subtitle {
            font-size: 22px;
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .top-prize-description {
            font-size: 18px;
            color: var(--light);
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background: rgba(26, 26, 46, 0.8);
            border-radius: 20px;
            padding: 25px;
            border: 3px solid;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-1 {
            border-color: var(--primary);
        }
        
        .card-2 {
            border-color: var(--secondary);
        }
        
        .card-3 {
            border-color: var(--accent);
        }
        
        .card-title {
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            font-size: 28px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .card-add-token {
            background: linear-gradient(45deg, #FFD166, #FF9E00);
            color: var(--dark);
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-family: 'Comic Neue', cursive;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .card-add-token:hover {
            transform: scale(1.05);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 8px;
            color: var(--light);
            font-size: 16px;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--secondary);
            border-radius: 10px;
            color: var(--light);
            font-size: 16px;
            font-family: 'Comic Neue', cursive;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.5);
        }
        
        .balance-info {
            font-size: 14px;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        .action-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka One', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-swap {
            background: linear-gradient(45deg, #00E5FF, #06D6A0);
            color: var(--dark);
        }
        
        .btn-transfer {
            background: linear-gradient(45deg, #FF6B9D, #EF476F);
            color: var(--light);
        }
        
        .btn-donate {
            background: linear-gradient(45deg, #FFD166, #FF9E00);
            color: var(--dark);
        }
        
        .action-button:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Stats Banner */
        .stats-banner {
            background: rgba(26, 26, 46, 0.8);
            border: 3px solid var(--secondary);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.2);
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(0, 229, 255, 0.2);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(255, 209, 102, 0.5);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 16px;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 30px 0;
            border-top: 5px dashed var(--primary);
            margin-top: 40px;
            color: var(--secondary);
        }
        
        .contract-address {
            background: rgba(0, 229, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 15px;
            font-family: monospace;
            font-size: 16px;
            border: 2px solid var(--secondary);
            cursor: pointer;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
            animation: slideIn 0.5s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 400px;
        }
        
        .notification-success {
            background: var(--success);
            border-left: 5px solid #06b686;
        }
        
        .notification-error {
            background: var(--danger);
            border-left: 5px solid #d43c5f;
        }
        
        .notification-info {
            background: var(--secondary);
            border-left: 5px solid #00b8d4;
        }
        
        .notification-warning {
            background: var(--accent);
            border-left: 5px solid #ffb300;
            color: var(--dark);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Meme Elements */
        .meme-emoji {
            position: absolute;
            font-size: 40px;
            z-index: -1;
            opacity: 0.5;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .logo-text {
                font-size: 28px;
            }
            
            .stats-banner {
                grid-template-columns: repeat(2, 1fr);
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .top-prize-title {
                font-size: 32px;
            }
            
            .top-prize-amount {
                font-size: 42px;
            }
            
            .top-prize-subtitle {
                font-size: 18px;
            }
        }
        
        /* Donate Options */
        .donate-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .donate-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--secondary);
            background: transparent;
            color: var(--secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Comic Neue', cursive;
            font-weight: bold;
        }
        
        .donate-option.active {
            background: var(--secondary);
            color: var(--dark);
        }
        
        .donate-option:hover {
            transform: scale(1.05);
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--light);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading {
            position: relative;
            color: transparent !important;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            left: calc(50% - 10px);
            top: calc(50% - 10px);
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--light);
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Gas Info */
        .gas-info {
            background: rgba(255, 209, 102, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--accent);
        }
        
        /* Rate Info */
        .rate-info {
            background: rgba(0, 229, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-top: 5px;
            font-size: 12px;
            color: var(--secondary);
        }
    </style>
</head>
<body>
    <div class="meme-emoji" style="top: 10%; left: 5%;">üöÄ</div>
    <div class="meme-emoji" style="top: 15%; right: 10%;">üíé</div>
    <div class="meme-emoji" style="bottom: 20%; left: 8%;">üî•</div>
    <div class="meme-emoji" style="bottom: 15%; right: 5%;">üéØ</div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-img">PPT</div>
                <div class="logo-text">Propagate Protocol Token</div>
            </div>
            <div class="header-controls">
                <div class="network-info">
                    <span id="networkStatus">Network: Not Connected</span>
                </div>
                <button class="add-token-btn" id="addTokenBtn">Add PPT to Wallet</button>
                <button class="connect-wallet" id="connectWallet">
                    <span>Connect Wallet</span>
                </button>
            </div>
        </header>
        
        <!-- Top Prize Pool Banner -->
        <div class="top-prize-banner" id="topPrizeBanner">
            <div class="top-prize-title">üéØ DAILY PRIZE POOL üéØ</div>
            <div class="top-prize-amount" id="topPrizeAmount">Loading Prize Pool...</div>
            <div class="top-prize-subtitle">Every transfer has 0.01% chance to win 1% of the prize pool!</div>
            <div class="top-prize-description">
                Win big when you transfer tokens! The more activity, the bigger the prize pool grows! 
                Every transaction contributes to the prize pool - 0.5% of each transfer tax goes directly to the prize pool!
            </div>
        </div>
        
        <!-- Main Content Cards -->
        <div class="main-content">
            <!-- Swap Card -->
            <div class="card card-1">
                <div class="card-header">
                    <div class="card-title">
                        <span>üîÑ</span> Swap MON for PPT
                    </div>
                    <button class="card-add-token add-token-card-btn" data-card="swap">+ Add PPT</button>
                </div>
                <p style="margin-bottom: 20px; color: var(--secondary);">Exchange your MON for PPT tokens at fixed rate of 1 MON = 10,000 PPT</p>
                <div class="input-group">
                    <div class="input-label">MON Amount to Swap</div>
                    <input type="number" class="input-field" id="swapAmount" placeholder="1.0" min="0" step="0.01" value="1">
                    <div class="balance-info">Your MON balance: <span id="monBalance">0</span> MON</div>
                </div>
                <div class="input-group">
                    <div class="input-label">PPT You'll Receive</div>
                    <input type="text" class="input-field" id="pptToReceive" placeholder="0" readonly>
                </div>
                <div class="balance-info">Fixed rate: 10,000 PPT per MON</div>
                <div class="rate-info">Rate details: 1 MON = 10,000 PPT (fixed rate)</div>
                <div class="gas-info" id="gasEstimate">Gas estimate: -</div>
                <button class="action-button btn-swap" id="swapTokens">SWAP NOW!</button>
            </div>
            
            <!-- Transfer Card -->
            <div class="card card-2">
                <div class="card-header">
                    <div class="card-title">
                        <span>üí∏</span> Transfer PPT
                    </div>
                    <button class="card-add-token add-token-card-btn" data-card="transfer">+ Add PPT</button>
                </div>
                <p style="margin-bottom: 20px; color: var(--primary);">Transfer PPT to another address. 1% tax applies (0.5% burn, 0.5% to prize pool).</p>
                <div class="input-group">
                    <div class="input-label">Recipient Address</div>
                    <input type="text" class="input-field" id="transferAddress" placeholder="0x...">
                </div>
                <div class="input-group">
                    <div class="input-label">PPT Amount</div>
                    <input type="number" class="input-field" id="transferAmount" placeholder="1000" min="0" step="100" value="1000">
                    <div class="balance-info">Your PPT balance: <span id="pptBalance">0</span> PPT</div>
                </div>
                <div class="input-group">
                    <div class="input-label">Recipient Will Receive</div>
                    <input type="text" class="input-field" id="transferReceive" placeholder="0" readonly>
                    <div class="balance-info">Tax: 1% (0.5% burned, 0.5% to prize pool)</div>
                </div>
                <div class="balance-info" id="transferChance">Chance to win prize: 0.01%</div>
                <button class="action-button btn-transfer" id="transferTokens">TRANSFER PPT!</button>
            </div>
            
            <!-- Donate Card -->
            <div class="card card-3">
                <div class="card-header">
                    <div class="card-title">
                        <span>üéóÔ∏è</span> Donate & Support
                    </div>
                    <button class="card-add-token add-token-card-btn" data-card="donate">+ Add PPT</button>
                </div>
                <p style="margin-bottom: 20px; color: var(--success);">Donate MON or PPT to support the project and grow the prize pool!</p>
                
                <div class="donate-options">
                    <button class="donate-option active" data-type="mon">MON</button>
                    <button class="donate-option" data-type="ppt">PPT</button>
                </div>
                
                <div class="input-group" id="monDonateGroup">
                    <div class="input-label">MON Amount to Donate</div>
                    <input type="number" class="input-field" id="monDonateAmount" placeholder="0.1" min="0" step="0.01" value="0.1">
                    <div class="balance-info">Directly supports the prize pool</div>
                </div>
                
                <div class="input-group" id="pptDonateGroup" style="display: none;">
                    <div class="input-label">PPT Amount to Donate</div>
                    <input type="number" class="input-field" id="pptDonateAmount" placeholder="1000" min="0" step="100" value="1000">
                    <div class="balance-info">1% tax applies (0.5% burned, 0.5% to prize pool)</div>
                </div>
                
                <button class="action-button btn-donate" id="donateTokens">DONATE & SUPPORT!</button>
            </div>
        </div>
        
        <!-- Stats Banner -->
        <div class="stats-banner" id="statsBanner">
            <div class="stat-item">
                <div class="stat-value" id="totalSupply">1T</div>
                <div class="stat-label">Total Supply</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="swapped">0</div>
                <div class="stat-label">Swapped</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="tokenPrizePool">0</div>
                <div class="stat-label">Prize Pool (PPT)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalBurned">0</div>
                <div class="stat-label">Total Burned</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentRate">10,000</div>
                <div class="stat-label">Current Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="contractBalance">0 MON</div>
                <div class="stat-label">Contract Balance</div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer>
            <p>Propagate Protocol Token (PPT) - The Meme Token with Purpose!</p>
            <p>Contract Address (Monad Testnet):</p>
            <div class="contract-address" id="contractAddress">0xE98bAF13bA17A768E009b557B96fbB3dd4f7824a</div>
            <p style="margin-top: 20px; font-size: 14px;">Remember: 1% tax on transfers, 0.5% burned forever, 0.5% to prize pool!</p>
            <p style="margin-top: 10px; font-size: 12px; color: var(--accent);">Network: Monad Testnet (Chain ID: 10143)</p>
        </footer>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Ê£ÄÊü•ethersÊòØÂê¶Âä†ËΩΩÊàêÂäü
        if (typeof ethers === 'undefined') {
            console.error('Ethers.js failed to load, trying alternative CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@5.7.0/dist/ethers.umd.min.js';
            script.onload = function() {
                console.log('Ethers.js loaded successfully from alternative CDN');
                initializeApp();
            };
            script.onerror = function() {
                console.error('Failed to load ethers.js from alternative CDN');
                showNotification('Failed to load required library. Please check your internet connection.', 'error');
            };
            document.head.appendChild(script);
        } else {
            console.log('Ethers.js loaded successfully');
            initializeApp();
        }
        
        // ÂàùÂßãÂåñÂ∫îÁî®
        function initializeApp() {
            // Monad Testnet Configuration
            const MONAD_TESTNET = {
                chainId: '0x279F',
                chainIdDecimal: 10143,
                chainName: 'Monad Testnet',
                nativeCurrency: {
                    name: 'MON',
                    symbol: 'MON',
                    decimals: 18
                },
                rpcUrls: ['https://testnet.monad.xyz'],
                blockExplorerUrls: ['https://testnet.monad.xyz/']
            };
            
            // Contract configuration - Êõ¥Êñ∞‰∏∫Êñ∞ÁöÑÂêàÁ∫¶Âú∞ÂùÄ
            const CONTRACT_ADDRESS = "0xE98bAF13bA17A768E009b557B96fbB3dd4f7824a";
            const CONTRACT_ABI = [
                "function swap() external payable",
                "function transfer(address to, uint256 amount) public returns (bool)",
                "function transferFrom(address from, address to, uint256 amount) public returns (bool)",
                "function getStats() external view returns (uint256 totalSupply, uint256 swapped, uint256 tokenPrizePoolAmount, uint256 burned, uint256 currentRate, uint256 contractMonBalance, uint256 contractPptBalance, uint256 transfersCount)",
                "function getCurrentRate() public pure returns (uint256)",
                "function getRemainingSwapPool() public view returns (uint256)",
                "function getPrizeInfo() external view returns (uint256 prizePoolPPT, uint256 prizePoolMON, uint256 chancePercent, uint256 timeSinceLastPrize)",
                "function balanceOf(address account) external view returns (uint256)",
                "function allowance(address owner, address spender) external view returns (uint256)",
                "function approve(address spender, uint256 amount) external returns (bool)",
                "event Swapped(address indexed user, uint256 monAmount, uint256 pptAmount)",
                "event PrizeWon(address indexed winner, uint256 tokenPrize, uint256 monPrize)",
                "event TokensBurned(uint256 amount)",
                "event DonationReceived(address donor, uint256 amount, bool isMon)"
            ];
            
            // Global variables
            let provider, signer, contract, userAddress, userBalance, userPPTBalance;
            let donateType = "mon";
            let isMonadNetwork = false;
            let statsInterval;
            
            // Âõ∫ÂÆöÂÖëÊç¢ÁéáÔºö1 MON = 10,000 PPT
            const FIXED_RATE = 10000;
            
            // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
            function setupEventListeners() {
                document.getElementById('connectWallet').addEventListener('click', checkNetworkAndConnect);
                document.getElementById('addTokenBtn').addEventListener('click', addToken);
                document.querySelectorAll('.add-token-card-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        addToken();
                    });
                });
                document.getElementById('swapTokens').addEventListener('click', swapTokens);
                document.getElementById('transferTokens').addEventListener('click', transferTokens);
                document.getElementById('donateTokens').addEventListener('click', donateTokens);
                document.querySelectorAll('.donate-option').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.donate-option').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        donateType = this.getAttribute('data-type');
                        updateDonateUI();
                    });
                });
                document.getElementById('swapAmount').addEventListener('input', calculateSwap);
                document.getElementById('transferAmount').addEventListener('input', calculateTransfer);
                document.getElementById('contractAddress').addEventListener('click', function() {
                    navigator.clipboard.writeText(CONTRACT_ADDRESS);
                    showNotification("Contract address copied to clipboard!", "info");
                });
            }
            
            // ÂàùÂßãÂåñweb3
            function initializeWeb3() {
                try {
                    if (typeof window.ethereum !== 'undefined') {
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                        console.log('Web3 initialized successfully');
                        return true;
                    } else {
                        showNotification("Please install MetaMask to use this dApp!", "error");
                        console.error('MetaMask not detected');
                        return false;
                    }
                } catch (error) {
                    console.error('Error initializing Web3:', error);
                    return false;
                }
            }
            
            // È°µÈù¢Âä†ËΩΩÊó∂Á´ãÂç≥Ëé∑ÂèñÂêàÁ∫¶‰ø°ÊÅØ
            async function loadContractInfo() {
                try {
                    if (!contract) {
                        if (!initializeWeb3()) {
                            return;
                        }
                    }
                    await updateStats();
                } catch (error) {
                    console.error('Error loading contract info:', error);
                    document.getElementById('totalSupply').textContent = "1T";
                    document.getElementById('topPrizeAmount').textContent = "Prize Pool Loading...";
                }
            }
            
            // ‰º∞ÁÆóGasË¥πÁî®
            async function estimateGasForSwap(amountWei) {
                try {
                    if (!contract || !userAddress) return "0";
                    
                    // ‰º∞ÁÆógas
                    const gasEstimate = await contract.estimateGas.swap({ value: amountWei });
                    const gasPrice = await provider.getGasPrice();
                    
                    // ËÆ°ÁÆógasË¥πÁî®
                    const gasCost = gasEstimate.mul(gasPrice);
                    const gasCostFormatted = ethers.utils.formatEther(gasCost);
                    
                    return {
                        gasEstimate: gasEstimate.toString(),
                        gasCost: gasCostFormatted,
                        totalCost: ethers.utils.formatEther(amountWei.add(gasCost))
                    };
                } catch (error) {
                    console.error("Error estimating gas:", error);
                    return null;
                }
            }
            
            // Check network and connect wallet
            async function checkNetworkAndConnect() {
                try {
                    if (!provider) {
                        if (!initializeWeb3()) {
                            return;
                        }
                    }
                    
                    let chainId;
                    try {
                        const network = await provider.getNetwork();
                        chainId = network.chainId.toString();
                        console.log('Current chain ID from provider:', chainId);
                    } catch (networkError) {
                        console.log('Error getting network from provider:', networkError);
                        chainId = await window.ethereum.request({ method: 'eth_chainId' });
                        console.log('Current chain ID from ethereum:', chainId);
                    }
                    
                    const chainIdNum = parseInt(chainId, chainId.startsWith('0x') ? 16 : 10);
                    
                    if (chainIdNum === MONAD_TESTNET.chainIdDecimal) {
                        isMonadNetwork = true;
                        document.getElementById('networkStatus').textContent = "Network: Monad Testnet";
                        await connectWallet();
                    } else {
                        isMonadNetwork = false;
                        document.getElementById('networkStatus').textContent = `Network: Wrong Network (ID: ${chainIdNum})`;
                        showNotification("Please switch to Monad Testnet (Chain ID: 10143)", "warning");
                        const connectBtn = document.getElementById('connectWallet');
                        connectBtn.innerHTML = '<span>Switch to Monad Testnet</span>';
                        connectBtn.onclick = switchToMonadNetwork;
                    }
                } catch (error) {
                    console.error("Error checking network:", error);
                    showNotification("Error checking network: " + error.message, "error");
                }
            }
            
            // Switch to Monad Testnet
            async function switchToMonadNetwork() {
                try {
                    console.log('Attempting to switch to Monad Testnet...');
                    const hexChainId = `0x${MONAD_TESTNET.chainIdDecimal.toString(16)}`;
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: hexChainId }],
                        });
                        console.log('Successfully switched to Monad Testnet');
                        showNotification("Switched to Monad Testnet!", "success");
                    } catch (switchError) {
                        console.log('Switch error:', switchError);
                        
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: hexChainId,
                                        chainName: MONAD_TESTNET.chainName,
                                        nativeCurrency: MONAD_TESTNET.nativeCurrency,
                                        rpcUrls: MONAD_TESTNET.rpcUrls,
                                        blockExplorerUrls: MONAD_TESTNET.blockExplorerUrls
                                    }]
                                });
                                console.log('Successfully added Monad Testnet');
                                showNotification("Monad Testnet added successfully!", "success");
                            } catch (addError) {
                                console.error('Add error:', addError);
                                if (addError.message && addError.message.includes('same RPC endpoint')) {
                                    showNotification("Monad Testnet is already in your wallet. Switching...", "info");
                                    setTimeout(() => {
                                        window.ethereum.emit('chainChanged', hexChainId);
                                    }, 1000);
                                } else {
                                    throw addError;
                                }
                            }
                        } else {
                            throw switchError;
                        }
                    }
                    
                    setTimeout(() => {
                        checkNetworkAndConnect();
                    }, 1500);
                    
                } catch (error) {
                    console.error("Error switching network:", error);
                    if (error.code === 4001) {
                        showNotification("Network switch rejected by user", "error");
                    } else {
                        showNotification("Failed to switch network: " + error.message, "error");
                    }
                    const connectBtn = document.getElementById('connectWallet');
                    connectBtn.innerHTML = '<span>Connect Wallet</span>';
                    connectBtn.onclick = checkNetworkAndConnect;
                }
            }
            
            // Connect wallet
            async function connectWallet() {
                try {
                    if (!provider) {
                        showNotification("Please install MetaMask first!", "error");
                        return;
                    }
                    
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    contract = contract.connect(signer);
                    
                    updateUI();
                    showNotification("Wallet connected successfully!", "success");
                    
                    await updateBalances();
                    await updateStats();
                    
                } catch (error) {
                    console.error("Error connecting wallet:", error);
                    if (error.code === 4001) {
                        showNotification("Connection rejected by user", "error");
                    } else {
                        showNotification("Failed to connect wallet: " + error.message, "error");
                    }
                }
            }
            
            // Add PPT token to MetaMask
            async function addToken() {
                try {
                    if (!window.ethereum) {
                        showNotification("Please install MetaMask first!", "error");
                        return;
                    }
                    
                    if (!userAddress) {
                        showNotification("Please connect your wallet first!", "info");
                        await connectWallet();
                        return;
                    }
                    
                    if (!isMonadNetwork) {
                        showNotification("Please switch to Monad Testnet first!", "info");
                        return;
                    }
                    
                    const wasAdded = await window.ethereum.request({
                        method: 'wallet_watchAsset',
                        params: {
                            type: 'ERC20',
                            options: {
                                address: CONTRACT_ADDRESS,
                                symbol: 'PPT',
                                decimals: 18,
                                image: 'https://placehold.co/64x64/FF6B9D/FFFFFF?text=PPT'
                            },
                        },
                    });
                    
                    if (wasAdded) {
                        showNotification("PPT token successfully added to your wallet!", "success");
                    } else {
                        showNotification("PPT token was not added. You can add it manually.", "info");
                    }
                } catch (error) {
                    console.error("Error adding token:", error);
                    showNotification("Failed to add token: " + error.message, "error");
                }
            }
            
            // Update UI with wallet info
            async function updateUI() {
                const connectBtn = document.getElementById('connectWallet');
                
                if (userAddress) {
                    const shortAddress = userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                    connectBtn.innerHTML = `
                        <div class="wallet-info">
                            <span>${shortAddress}</span>
                            <div class="wallet-balance" id="walletBalanceDisplay">Loading balances...</div>
                        </div>
                    `;
                    updateWalletBalanceDisplay();
                } else {
                    connectBtn.innerHTML = '<span>Connect Wallet</span>';
                    connectBtn.onclick = checkNetworkAndConnect;
                }
            }
            
            // Êõ¥Êñ∞Èí±ÂåÖ‰ΩôÈ¢ùÊòæÁ§∫Âú®ÊåâÈíÆ‰∏ä
            async function updateWalletBalanceDisplay() {
                try {
                    if (!provider || !userAddress) return;
                    
                    const monBalance = await provider.getBalance(userAddress);
                    const monBalanceFormatted = ethers.utils.formatEther(monBalance);
                    
                    let pptBalanceFormatted = "0";
                    try {
                        const pptBalance = await contract.balanceOf(userAddress);
                        pptBalanceFormatted = ethers.utils.formatEther(pptBalance);
                    } catch (error) {
                        console.error("Error getting PPT balance:", error);
                    }
                    
                    const displayText = `MON: ${parseFloat(monBalanceFormatted).toFixed(2)} | PPT: ${parseFloat(pptBalanceFormatted).toFixed(2)}`;
                    const walletBalanceDisplay = document.getElementById('walletBalanceDisplay');
                    if (walletBalanceDisplay) {
                        walletBalanceDisplay.textContent = displayText;
                    }
                    
                } catch (error) {
                    console.error("Error updating wallet balance display:", error);
                    const walletBalanceDisplay = document.getElementById('walletBalanceDisplay');
                    if (walletBalanceDisplay) {
                        walletBalanceDisplay.textContent = "Error loading balances";
                    }
                }
            }
            
            // Update user balances
            async function updateBalances() {
                try {
                    if (!provider || !userAddress) return;
                    
                    userBalance = await provider.getBalance(userAddress);
                    const monBalanceFormatted = ethers.utils.formatEther(userBalance);
                    document.getElementById('monBalance').textContent = parseFloat(monBalanceFormatted).toFixed(4);
                    
                    userPPTBalance = await contract.balanceOf(userAddress);
                    const pptBalanceFormatted = ethers.utils.formatEther(userPPTBalance);
                    document.getElementById('pptBalance').textContent = formatNumber(pptBalanceFormatted);
                    
                    updateWalletBalanceDisplay();
                    
                } catch (error) {
                    console.error("Error updating balances:", error);
                }
            }
            
            // Update stats from contract - ÂÆåÊï¥ÁâàÊú¨Ôºå‰ΩøÁî®‰ªéÈìæ‰∏äËé∑ÂèñÁöÑÁúüÂÆûÊï∞ÊçÆ
            async function updateStats() {
                try {
                    if (!contract) return;
                    
                    const stats = await contract.getStats();
                    const totalSupply = stats[0];
                    const swapped = stats[1];
                    const tokenPrizePoolAmount = stats[2];
                    const burned = stats[3];
                    const currentRate = stats[4];
                    const contractMonBalance = stats[5];
                    
                    // Êõ¥Êñ∞È°∂ÈÉ®Â•ñÊ±†ÊòæÁ§∫
                    const tokenPrizePoolFormatted = formatNumber(ethers.utils.formatEther(tokenPrizePoolAmount));
                    const contractBalanceFormatted = parseFloat(ethers.utils.formatEther(contractMonBalance)).toFixed(2);
                    document.getElementById('topPrizeAmount').textContent = 
                        `${tokenPrizePoolFormatted} PPT + ${contractBalanceFormatted} MON`;
                    
                    // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                    document.getElementById('totalSupply').textContent = formatNumber(ethers.utils.formatEther(totalSupply));
                    document.getElementById('swapped').textContent = formatNumber(ethers.utils.formatEther(swapped));
                    document.getElementById('tokenPrizePool').textContent = formatNumber(ethers.utils.formatEther(tokenPrizePoolAmount));
                    document.getElementById('totalBurned').textContent = formatNumber(ethers.utils.formatEther(burned));
                    document.getElementById('currentRate').textContent = currentRate.toLocaleString();
                    document.getElementById('contractBalance').textContent = contractBalanceFormatted + " MON";
                    
                } catch (error) {
                    console.error("Error updating stats:", error);
                    updateStatsFallback();
                }
            }
            
            // ÂêàÁ∫¶Ë∞ÉÁî®Â§±Ë¥•Êó∂ÁöÑÂ§áÈÄâÊòæÁ§∫
            function updateStatsFallback() {
                document.getElementById('totalSupply').textContent = "1T";
                document.getElementById('topPrizeAmount').textContent = "Prize Pool Loading...";
            }
            
            // Swap MON for PPT - ÂÆåÊï¥ÁâàÊú¨Ôºå‰ΩøÁî®ÁúüÂÆûÈìæ‰∏äÊï∞ÊçÆ
            async function swapTokens() {
                try {
                    if (!userAddress) {
                        showNotification("Please connect your wallet first!", "error");
                        return;
                    }
                    
                    if (!isMonadNetwork) {
                        showNotification("Please switch to Monad Testnet first!", "error");
                        return;
                    }
                    
                    const amountInput = document.getElementById('swapAmount').value;
                    if (!amountInput || parseFloat(amountInput) <= 0) {
                        showNotification("Please enter a valid amount!", "error");
                        return;
                    }
                    
                    const amountWei = ethers.utils.parseEther(amountInput);
                    
                    if (userBalance.lt(amountWei)) {
                        showNotification(`Insufficient MON balance. You have ${ethers.utils.formatEther(userBalance)} MON`, "error");
                        return;
                    }
                    
                    // Ê£ÄÊü•ÂêàÁ∫¶ÊòØÂê¶ËøòÊúâË∂≥Â§üÁöÑPPTÂÖëÊç¢Ê±†
                    try {
                        const remainingSwapPool = await contract.getRemainingSwapPool();
                        const remainingSwapPoolFormatted = ethers.utils.formatEther(remainingSwapPool);
                        const pptAmount = parseFloat(amountInput) * FIXED_RATE;
                        const tokensOutWei = ethers.utils.parseEther(pptAmount.toString());
                        
                        if (remainingSwapPool.lt(tokensOutWei)) {
                            showNotification(`Insufficient PPT in swap pool. Remaining: ${formatNumber(remainingSwapPoolFormatted)} PPT`, "error");
                            return;
                        }
                    } catch (error) {
                        console.error("Error checking swap pool:", error);
                        // ÁªßÁª≠ÊâßË°åÔºåÂêàÁ∫¶‰ºöÊ£ÄÊü•
                    }
                    
                    // ‰º∞ÁÆógasË¥πÁî®
                    showNotification("Estimating gas fees...", "info");
                    let gasEstimate;
                    try {
                        gasEstimate = await contract.estimateGas.swap({ value: amountWei });
                    } catch (estimateError) {
                        console.error("Gas estimation error:", estimateError);
                        // Â¶ÇÊûúgas‰º∞ÁÆóÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº
                        gasEstimate = ethers.BigNumber.from("120000");
                    }
                    
                    const gasPrice = await provider.getGasPrice();
                    const gasCost = gasEstimate.mul(gasPrice);
                    
                    // Ê£ÄÊü•‰ΩôÈ¢ùÊòØÂê¶Ë∂≥Â§üÊîØ‰ªòswapÈáëÈ¢ù+gasË¥πÁî®
                    const totalRequired = amountWei.add(gasCost);
                    if (userBalance.lt(totalRequired)) {
                        showNotification(`Insufficient MON for swap + gas. You need ${ethers.utils.formatEther(totalRequired)} MON (Swap: ${amountInput} + Gas: ${ethers.utils.formatEther(gasCost)})`, "error");
                        return;
                    }
                    
                    showNotification(`Swapping ${amountInput} MON for ${(parseFloat(amountInput) * FIXED_RATE).toLocaleString()} PPT...`, "info");
                    setButtonLoading('swapTokens', true);
                    
                    // ÂèëÈÄÅ‰∫§Êòì - ‰ΩøÁî®Ê≠£Á°ÆÁöÑgasÈôêÈ¢ù
                    const tx = await contract.swap({ 
                        value: amountWei,
                        gasLimit: gasEstimate.mul(12).div(10) // Â¢ûÂä†20%ÁöÑgasÈôêÈ¢ù
                    });
                    
                    showNotification("Transaction submitted! Waiting for confirmation...", "info");
                    const receipt = await tx.wait();
                    
                    // Ê£ÄÊü•‰∫ã‰ª∂
                    let eventFound = false;
                    let tokensReceived = "0";
                    if (receipt.events) {
                        for (const event of receipt.events) {
                            if (event.event === 'Swapped') {
                                eventFound = true;
                                tokensReceived = ethers.utils.formatEther(event.args.pptAmount);
                                break;
                            }
                        }
                    }
                    
                    if (eventFound) {
                        showNotification(`Swap successful! You received ${parseFloat(tokensReceived).toLocaleString()} PPT tokens.`, "success");
                    } else {
                        showNotification("Swap completed. Please check your wallet balance.", "warning");
                    }
                    
                    // Êõ¥Êñ∞ÁªüËÆ°Âíå‰ΩôÈ¢ù
                    await updateStats();
                    await updateBalances();
                    
                    // ÈáçÁΩÆËæìÂÖ•
                    document.getElementById('swapAmount').value = "";
                    document.getElementById('pptToReceive').value = "";
                    document.getElementById('gasEstimate').textContent = "Gas estimate: -";
                    
                } catch (error) {
                    console.error("Error swapping tokens:", error);
                    
                    if (error.code === 4001) {
                        showNotification("Transaction rejected by user", "error");
                    } else if (error.message.includes("Insufficient gas payment")) {
                        showNotification("Insufficient gas payment. Increase the amount.", "error");
                    } else if (error.message.includes("Swap pool exhausted")) {
                        showNotification("Swap pool is exhausted", "error");
                    } else if (error.message.includes("Minimum swap is 0.001 MON")) {
                        showNotification("Minimum swap amount is 0.001 MON", "error");
                    } else if (error.message.includes("Insufficient PPT in swap pool")) {
                        showNotification("Insufficient PPT in swap pool. Try a smaller amount.", "error");
                    } else if (error.message.includes("Swap pool limit reached")) {
                        showNotification("Swap pool limit reached. No more swaps available.", "error");
                    } else if (error.message.includes("revert")) {
                        showNotification("Transaction reverted. Please check if amount is sufficient.", "error");
                    } else if (error.message.includes("insufficient funds")) {
                        showNotification("Insufficient funds for swap", "error");
                    } else {
                        showNotification("Failed to swap: " + error.message, "error");
                    }
                } finally {
                    setButtonLoading('swapTokens', false);
                }
            }
            
            // Transfer PPT tokens
            async function transferTokens() {
                try {
                    if (!userAddress) {
                        showNotification("Please connect your wallet first!", "error");
                        return;
                    }
                    
                    if (!isMonadNetwork) {
                        showNotification("Please switch to Monad Testnet first!", "error");
                        return;
                    }
                    
                    const recipient = document.getElementById('transferAddress').value.trim();
                    const amount = document.getElementById('transferAmount').value;
                    
                    if (!recipient) {
                        showNotification("Please enter a recipient address!", "error");
                        return;
                    }
                    
                    if (!ethers.utils.isAddress(recipient)) {
                        showNotification("Please enter a valid recipient address!", "error");
                        return;
                    }
                    
                    if (!amount || parseFloat(amount) <= 0) {
                        showNotification("Please enter a valid amount!", "error");
                        return;
                    }
                    
                    const amountWei = ethers.utils.parseEther(amount);
                    
                    if (userPPTBalance.lt(amountWei)) {
                        showNotification(`Insufficient PPT balance. You have ${ethers.utils.formatEther(userPPTBalance)} PPT`, "error");
                        return;
                    }
                    
                    const gasEstimate = await contract.estimateGas.transfer(recipient, amountWei);
                    const gasPrice = await provider.getGasPrice();
                    const gasCost = gasEstimate.mul(gasPrice);
                    
                    if (userBalance.lt(gasCost)) {
                        showNotification(`Insufficient MON for gas. Need at least ${ethers.utils.formatEther(gasCost)} MON`, "error");
                        return;
                    }
                    
                    showNotification(`Transferring ${amount} PPT...`, "info");
                    setButtonLoading('transferTokens', true);
                    
                    const tx = await contract.transfer(recipient, amountWei);
                    await tx.wait();
                    
                    showNotification("Transfer successful! 1% tax applied (0.5% burned, 0.5% to prize pool).", "success");
                    updateStats();
                    updateBalances();
                    
                    document.getElementById('transferAddress').value = "";
                    document.getElementById('transferAmount').value = "";
                    document.getElementById('transferReceive').value = "";
                    
                } catch (error) {
                    console.error("Error transferring tokens:", error);
                    
                    if (error.code === 4001) {
                        showNotification("Transaction rejected by user", "error");
                    } else {
                        showNotification("Failed to transfer: " + error.message, "error");
                    }
                } finally {
                    setButtonLoading('transferTokens', false);
                }
            }
            
            // Donate tokens
            async function donateTokens() {
                try {
                    if (!userAddress) {
                        showNotification("Please connect your wallet first!", "error");
                        return;
                    }
                    
                    if (!isMonadNetwork) {
                        showNotification("Please switch to Monad Testnet first!", "error");
                        return;
                    }
                    
                    if (donateType === "mon") {
                        const amountInput = document.getElementById('monDonateAmount').value;
                        
                        if (!amountInput || parseFloat(amountInput) <= 0) {
                            showNotification("Please enter a valid amount!", "error");
                            return;
                        }
                        
                        const amountWei = ethers.utils.parseEther(amountInput);
                        
                        if (userBalance.lt(amountWei)) {
                            showNotification(`Insufficient MON balance. You have ${ethers.utils.formatEther(userBalance)} MON`, "error");
                            return;
                        }
                        
                        showNotification(`Donating ${amountInput} MON...`, "info");
                        setButtonLoading('donateTokens', true);
                        
                        // ‰ΩøÁî®ÂêàÁ∫¶ÁöÑdonateMonÂáΩÊï∞
                        const tx = await contract.donateMon({ value: amountWei });
                        
                        await tx.wait();
                        
                        showNotification("Donation successful! Thank you for supporting the prize pool!", "success");
                        
                        document.getElementById('monDonateAmount').value = "";
                        
                    } else {
                        const amountInput = document.getElementById('pptDonateAmount').value;
                        const recipient = CONTRACT_ADDRESS;
                        
                        if (!amountInput || parseFloat(amountInput) <= 0) {
                            showNotification("Please enter a valid amount!", "error");
                            return;
                        }
                        
                        const amountWei = ethers.utils.parseEther(amountInput);
                        
                        if (userPPTBalance.lt(amountWei)) {
                            showNotification(`Insufficient PPT balance. You have ${ethers.utils.formatEther(userPPTBalance)} PPT`, "error");
                            return;
                        }
                        
                        const gasEstimate = await contract.estimateGas.transfer(recipient, amountWei);
                        const gasPrice = await provider.getGasPrice();
                        const gasCost = gasEstimate.mul(gasPrice);
                        
                        if (userBalance.lt(gasCost)) {
                            showNotification(`Insufficient MON for gas. Need at least ${ethers.utils.formatEther(gasCost)} MON`, "error");
                            return;
                        }
                        
                        showNotification(`Donating ${amountInput} PPT...`, "info");
                        setButtonLoading('donateTokens', true);
                        
                        const tx = await contract.transfer(recipient, amountWei);
                        await tx.wait();
                        
                        showNotification("Donation successful! 1% tax applied (0.5% burned, 0.5% to prize pool).", "success");
                        
                        document.getElementById('pptDonateAmount').value = "";
                    }
                    
                    updateStats();
                    updateBalances();
                    
                } catch (error) {
                    console.error("Error donating:", error);
                    
                    if (error.code === 4001) {
                        showNotification("Transaction rejected by user", "error");
                    } else {
                        showNotification("Failed to donate: " + error.message, "error");
                    }
                } finally {
                    setButtonLoading('donateTokens', false);
                }
            }
            
            // Calculate PPT to receive from swap - ÂÆåÊï¥ÁâàÊú¨
            async function calculateSwap() {
                const amount = document.getElementById('swapAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    document.getElementById('pptToReceive').value = "";
                    document.getElementById('gasEstimate').textContent = "Gas estimate: -";
                    return;
                }
                
                try {
                    const amountWei = ethers.utils.parseEther(amount);
                    
                    // ‰ΩøÁî®Âõ∫ÂÆöÂÖëÊç¢ÁéáËÆ°ÁÆóPPTÊï∞Èáè
                    const pptAmount = parseFloat(amount) * FIXED_RATE;
                    
                    // ÊòæÁ§∫ÁªìÊûú
                    document.getElementById('pptToReceive').value = pptAmount.toLocaleString();
                    
                    // Ê£ÄÊü•ÂêàÁ∫¶ÊòØÂê¶ÊúâË∂≥Â§üÁöÑPPTÂÖëÊç¢Ê±†
                    try {
                        if (contract && userAddress) {
                            const remainingSwapPool = await contract.getRemainingSwapPool();
                            const remainingSwapPoolFormatted = ethers.utils.formatEther(remainingSwapPool);
                            const tokensOutWei = ethers.utils.parseEther(pptAmount.toString());
                            
                            if (remainingSwapPool.lt(tokensOutWei)) {
                                document.getElementById('pptToReceive').value = `Max: ${formatNumber(remainingSwapPoolFormatted)} PPT`;
                                showNotification("Swap pool limit may be reached. Try a smaller amount.", "warning");
                            }
                        }
                    } catch (error) {
                        console.error("Error checking swap pool:", error);
                    }
                    
                    // ‰º∞ÁÆógasË¥πÁî®
                    if (contract && userAddress) {
                        const gasInfo = await estimateGasForSwap(amountWei);
                        if (gasInfo) {
                            document.getElementById('gasEstimate').textContent = 
                                `Gas: ${parseFloat(gasInfo.gasCost).toFixed(6)} MON | Total: ${parseFloat(gasInfo.totalCost).toFixed(6)} MON`;
                        }
                    }
                } catch (error) {
                    console.error("Error calculating swap:", error);
                    // Â¶ÇÊûúËÆ°ÁÆóÂ§±Ë¥•Ôºå‰ΩøÁî®ÁÆÄÂçïÁöÑËøë‰ººËÆ°ÁÆó
                    const pptAmount = parseFloat(amount) * FIXED_RATE;
                    document.getElementById('pptToReceive').value = pptAmount.toLocaleString();
                    document.getElementById('gasEstimate').textContent = "Gas estimate: Error calculating";
                }
            }
            
            // Calculate transfer after tax
            function calculateTransfer() {
                const amount = document.getElementById('transferAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    document.getElementById('transferReceive').value = "";
                    return;
                }
                
                const tax = parseFloat(amount) * 0.01;
                const received = parseFloat(amount) - tax;
                document.getElementById('transferReceive').value = received.toFixed(2);
            }
            
            // Update donate UI based on selected type
            function updateDonateUI() {
                if (donateType === "mon") {
                    document.getElementById('monDonateGroup').style.display = 'block';
                    document.getElementById('pptDonateGroup').style.display = 'none';
                } else {
                    document.getElementById('monDonateGroup').style.display = 'none';
                    document.getElementById('pptDonateGroup').style.display = 'block';
                }
            }
            
            // Show notification
            function showNotification(message, type = "info") {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification notification-${type}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
            
            // Set button loading state
            function setButtonLoading(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (isLoading) {
                    button.classList.add('loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }
            
            // Format large numbers (Áî®‰∫éÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ)
            function formatNumber(numStr) {
                const num = parseFloat(numStr);
                if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
                if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
                if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
                if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
                if (num >= 1) return num.toLocaleString();
                return num.toFixed(6);
            }
            
            // ÂàùÂßãÂåñÂ∫îÁî®
            function init() {
                if (initializeWeb3()) {
                    setupEventListeners();
                    updateDonateUI();
                    
                    // È°µÈù¢Âä†ËΩΩÂêéËá™Âä®ËÆ°ÁÆóÈªòËÆ§ÂÄº
                    setTimeout(() => {
                        calculateSwap();
                        calculateTransfer();
                    }, 1000);
                    
                    loadContractInfo();
                    
                    statsInterval = setInterval(() => {
                        loadContractInfo();
                    }, 30000);
                    
                    if (window.ethereum) {
                        window.ethereum.on('chainChanged', async (chainId) => {
                            console.log('Chain changed event:', chainId);
                            setTimeout(checkNetworkAndConnect, 500);
                        });
                    }
                    
                    if (window.ethereum && window.ethereum.selectedAddress) {
                        setTimeout(checkNetworkAndConnect, 500);
                    }
                    
                    console.log('PPT DApp initialized successfully');
                }
            }
            
            init();
        }
    </script>
</body>
</html>